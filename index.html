<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pacific Islands Digital Pulse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html { scroll-behavior: smooth; }
    .floating-panel {
      position: fixed;
      top: 50%;
      right: 1rem;
      transform: translateY(-50%);
      z-index: 50;
      background-color: white;
      border: 1px solid #cbd5e0;
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    #internetMap {
      height: 400px;
      border-radius: 0.5rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <header class="bg-blue-700 text-white py-6 text-center shadow">
    <h1 class="text-3xl font-bold">ğŸŒ Pacific Islands Digital Pulse</h1>
    <p class="text-lg mt-2">Digital Indicators Across the Blue Pacific</p>
  </header>

  <div class="floating-panel w-72">
    <h2 class="text-lg font-semibold mb-2 text-blue-600 flex items-center gap-2">
      <i data-feather="filter" class="w-4 h-4"></i> Filters
    </h2>
    <label class="block text-sm font-medium text-gray-700">Cultural Region</label>
    <select id="regionFilter" class="w-full mt-1 mb-4 border-gray-300 rounded-md">
      <option value="All">All Regions</option>
      <option value="MELANESIA">Melanesia</option>
      <option value="MICRONESIA">Micronesia</option>
      <option value="POLYNESIA">Polynesia</option>
    </select>
    <button id="downloadBtn" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm font-medium">
      â¬‡ï¸ Download Excel
    </button>
  </div>

  <main class="max-w-6xl mx-auto px-4 py-16">
    <div class="grid grid-cols-1 sm:grid-cols-5 gap-6 mb-10">
      <div class="bg-blue-100 rounded-lg shadow p-6 text-center">
        <h3 class="text-sm text-gray-600 mb-2">Avg. Internet Usage</h3>
        <p id="avgInternet" class="text-3xl font-bold text-blue-700">--%</p>
      </div>
      <div class="bg-blue-100 rounded-lg shadow p-6 text-center">
        <h3 class="text-sm text-gray-600 mb-2">Avg. 4G Coverage</h3>
        <p id="avg4G" class="text-3xl font-bold text-blue-700">--%</p>
      </div>
      <div class="bg-blue-100 rounded-lg shadow p-6 text-center">
        <h3 class="text-sm text-gray-600 mb-2">Avg. Broadband</h3>
        <p id="avgBroadband" class="text-3xl font-bold text-blue-700">--</p>
      </div>
      <div class="bg-blue-100 rounded-lg shadow p-6 text-center">
        <h3 class="text-sm text-gray-600 mb-2">Cyber Index Count</h3>
        <p id="countCyberIndex" class="text-3xl font-bold text-blue-700">--</p>
      </div>
      <div class="bg-blue-100 rounded-lg shadow p-6 text-center">
        <h3 class="text-sm text-gray-600 mb-2">E-Gov Index Count</h3>
        <p id="countEGovIndex" class="text-3xl font-bold text-blue-700">--</p>
      </div>
    </div>

    <!-- Average Internet & 4G Coverage Bar Chart -->
    <div class="mt-12">
      <h2 class="text-xl font-bold text-blue-700 mb-4">ğŸ“¶ Average Internet vs 4G Coverage by Country</h2>
      <canvas id="avgUsageCoverageChart"></canvas>
    </div>

    <!-- Map -->
    <div class="mt-16">
      <h2 class="text-xl font-bold text-blue-700 mb-4">ğŸ—ºï¸ Internet Usage Map (Average by Country)</h2>
      <div id="internetMap"></div>
    </div>

    <div class="space-y-12 mt-16">
      <div>
        <h2 class="text-xl font-bold text-blue-700 mb-4">ğŸ“Š Internet Usage by Country</h2>
        <canvas id="internetChart"></canvas>
      </div>
      <div>
        <h2 class="text-xl font-bold text-blue-700 mb-4">ğŸ›°ï¸ Fixed Broadband Subscriptions</h2>
        <canvas id="broadbandChart"></canvas>
      </div>
      <div>
        <h2 class="text-xl font-bold text-blue-700 mb-4">ğŸ“¶ 4G Mobile Coverage</h2>
        <canvas id="coverageChart"></canvas>
      </div>
    </div>

    <div class="mt-16">
      <h2 class="text-xl font-bold text-blue-700 mb-4">ğŸ“‹ Indicator Heatmap Table</h2>
      <div class="overflow-x-auto bg-white rounded-lg shadow">
        <table class="min-w-full divide-y divide-gray-200 text-sm text-gray-800">
          <thead class="bg-blue-100">
            <tr>
              <th class="px-4 py-2 text-left">Country</th>
              <th class="px-4 py-2 text-left">Internet Usage</th>
              <th class="px-4 py-2 text-left">4G Coverage</th>
              <th class="px-4 py-2 text-left">Broadband</th>
            </tr>
          </thead>
          <tbody id="heatmapBody" class="divide-y divide-gray-100">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    feather.replace();
    const excelURL = 'https://raw.githubusercontent.com/rovawaqa/pacific-digital-readines/main/Final%20Data.xlsx';
    let fullData = [];

    const regionFilter = document.getElementById('regionFilter');
    const downloadBtn = document.getElementById('downloadBtn');

    function cleanAverage(data, key) {
      const vals = data.map(row => row[key]).filter(v => v !== "" && !isNaN(v)).map(Number);
      return vals.length ? (vals.reduce((a, b) => a + b, 0) / vals.length) : 0;
    }

    function getColor(value, min, max) {
      if (value === null || value === "" || isNaN(value)) return "#f87171";
      const percent = (value - min) / (max - min);
      const shade = Math.round(255 - percent * 155);
      return `rgb(${shade}, ${shade}, 255)`;
    }

    function updateCards(data) {
      document.getElementById('avgInternet').textContent = cleanAverage(data, "Proportion of individuals using the Internet").toFixed(1) + "%";
      document.getElementById('avgBroadband').textContent = cleanAverage(data, "Fixed Internet broadband subscriptions per 100Â inhabitants").toFixed(1);
      document.getElementById('avg4G').textContent = cleanAverage(data, "Proportion of population covered by at least a 4G mobile").toFixed(1) + "%";
      document.getElementById('countCyberIndex').textContent = data.filter(d => d["National Cyber Security Index"]).length;
      document.getElementById('countEGovIndex').textContent = data.filter(d => d[" E-Goverment Index"]).length;
    }

    function drawChart(canvasId, label, key, data) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const labels = data.map(row => row["Country"]);
      const values = data.map(row => parseFloat(row[key]) || 0);
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label, data: values, backgroundColor: 'rgba(54,162,235,0.6)', borderColor: 'rgba(54,162,235,1)', borderWidth: 1 }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function drawUsageCoverageChart(data) {
      const grouped = {};
      data.forEach(d => {
        const country = d["Country"];
        if (!grouped[country]) grouped[country] = [];
        grouped[country].push(d);
      });

      const labels = [];
      const internetData = [];
      const coverageData = [];

      for (const country in grouped) {
        const rows = grouped[country];
        const avgInternet = rows.map(r => parseFloat(r["Proportion of individuals using the Internet"])).filter(v => !isNaN(v));
        const avg4G = rows.map(r => parseFloat(r["Proportion of population covered by at least a 4G mobile"])).filter(v => !isNaN(v));

        labels.push(country);
        internetData.push(avgInternet.length ? avgInternet.reduce((a, b) => a + b) / avgInternet.length : 0);
        coverageData.push(avg4G.length ? avg4G.reduce((a, b) => a + b) / avg4G.length : 0);
      }

      const ctx = document.getElementById("avgUsageCoverageChart").getContext("2d");
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: "Internet Usage (%)",
              data: internetData,
              backgroundColor: "rgba(59, 130, 246, 0.6)"
            },
            {
              label: "4G Coverage (%)",
              data: coverageData,
              backgroundColor: "rgba(16, 185, 129, 0.6)"
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: { display: true, text: "Percentage" }
            },
            x: { stacked: false }
          }
        }
      });
    }

    function drawInternetMap(data) {
      if (window.internetMap) window.internetMap.remove();

      const countryAvgs = {};
      const grouped = {};
      data.forEach(d => {
        const country = d["Country"];
        if (!grouped[country]) grouped[country] = [];
        grouped[country].push(d);
      });

      for (const country in grouped) {
        const rows = grouped[country];
        const vals = rows.map(r => parseFloat(r["Proportion of individuals using the Internet"])).filter(v => !isNaN(v));
        if (vals.length) {
          const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
          countryAvgs[country] = avg;
        }
      }

      window.internetMap = L.map('internetMap').setView([-10, 175], 3); // Center on Pacific
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(window.internetMap);

      fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
        .then(res => res.json())
        .then(geojson => {
          const getColor = d => {
            return d > 90 ? '#1a9850' :
                   d > 70 ? '#66bd63' :
                   d > 50 ? '#a6d96a' :
                   d > 30 ? '#d9ef8b' :
                   d > 10 ? '#fee08b' :
                   d > 0  ? '#fdae61' :
                            '#f46d43';
          };

          L.geoJSON(geojson, {
            style: feature => {
              const name = feature.properties.ADMIN;
              const val = countryAvgs[name];
              return {
                fillColor: getColor(val),
                weight: 1,
                opacity: 1,
                color: 'white',
                fillOpacity: 0.7
              };
            },
            onEachFeature: (feature, layer) => {
              const name = feature.properties.ADMIN;
              const val = countryAvgs[name];
              if (val !== undefined) {
                layer.bindTooltip(`${name}: ${val.toFixed(1)}%`);
              } else {
                layer.bindTooltip(`${name}: N/A`);
              }
            }
          }).addTo(window.internetMap);
        });
    }

    function renderHeatmapTable(data) {
      const tbody = document.getElementById("heatmapBody");
      tbody.innerHTML = "";
      const getVals = key => data.map(d => parseFloat(d[key])).filter(v => !isNaN(v));
      const ranges = {
        internet: [Math.min(...getVals("Proportion of individuals using the Internet")), Math.max(...getVals("Proportion of individuals using the Internet"))],
        coverage: [Math.min(...getVals("Proportion of population covered by at least a 4G mobile")), Math.max(...getVals("Proportion of population covered by at least a 4G mobile"))],
        broadband: [Math.min(...getVals("Fixed Internet broadband subscriptions per 100Â inhabitants")), Math.max(...getVals("Fixed Internet broadband subscriptions per 100Â inhabitants"))],
      };
      data.forEach(row => {
        const internet = parseFloat(row["Proportion of individuals using the Internet"]);
        const coverage = parseFloat(row["Proportion of population covered by at least a 4G mobile"]);
        const broadband = parseFloat(row["Fixed Internet broadband subscriptions per 100Â inhabitants"]);
        tbody.innerHTML += `
          <tr>
            <td class="px-4 py-2 font-medium hover:underline cursor-pointer" onclick="drillThrough('${row['Country']}')">${row["Country"]}</td>
            <td class="px-4 py-2" style="background-color:${getColor(internet, ...ranges.internet)}">${isNaN(internet) ? "N/A" : internet}</td>
            <td class="px-4 py-2" style="background-color:${getColor(coverage, ...ranges.coverage)}">${isNaN(coverage) ? "N/A" : coverage}</td>
            <td class="px-4 py-2" style="background-color:${getColor(broadband, ...ranges.broadband)}">${isNaN(broadband) ? "N/A" : broadband}</td>
          </tr>`;
      });
    }

    let internetChart, broadbandChart, coverageChart, avgUsageCoverageChart;

    function filterAndUpdate() {
      const region = regionFilter.value;
      const filtered = region === "All" ? fullData : fullData.filter(d => d["CULTURAL REGION"] === region);
      updateCards(filtered);
      internetChart?.destroy();
      broadbandChart?.destroy();
      coverageChart?.destroy();
      avgUsageCoverageChart?.destroy();
      internetChart = drawChart("internetChart", "Internet Usage", "Proportion of individuals using the Internet", filtered);
      broadbandChart = drawChart("broadbandChart", "Broadband Subscriptions", "Fixed Internet broadband subscriptions per 100Â inhabitants", filtered);
      coverageChart = drawChart("coverageChart", "4G Coverage", "Proportion of population covered by at least a 4G mobile", filtered);
      avgUsageCoverageChart = drawUsageCoverageChart(filtered);
      renderHeatmapTable(filtered);
      drawInternetMap(filtered);
    }

    fetch(excelURL).then(r => r.arrayBuffer()).then(data => {
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      fullData = XLSX.utils.sheet_to_json(sheet);
      filterAndUpdate();
    });

    regionFilter.addEventListener('change', filterAndUpdate);
    downloadBtn.addEventListener('click', () => {
      const ws = XLSX.utils.json_to_sheet(fullData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Filtered Data");
      XLSX.writeFile(wb, "Pacific-Digital-Indicators.xlsx");
    });

    function drillThrough(country) {
      alert(`Drill-through: You clicked ${country}`);
      // Optionally navigate to detailed page here
    }
  </script>
</body>
</html>
